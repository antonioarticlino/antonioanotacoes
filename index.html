<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <title>Compras e Vendas - Minecraft Style</title>
  <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
  <style>
    html, body {
      margin: 0;
      padding: 0;
      width: 100%;
      height: 100%;
      font-family: 'Press Start 2P', cursive;
      background-color: #000;
      background-size: 64px;
      color: #fff;
    }
    .container {
      width: 100%;
      height: 100%;
      padding: 30px;
      background: rgba(0, 0, 0, 0.85);
      box-sizing: border-box;
      border: 4px solid #3e3e3e;
    }
    h2 {
      color: #8fff5f;
      text-align: center;
      text-shadow: 2px 2px #000;
      margin-bottom: 30px;
    }
    input, select, button {
      font-family: 'Press Start 2P', monospace;
      padding: 10px;
      margin: 5px;
      font-size: 12px;
      border-radius: 0;
      border: 3px solid #000;
      background: #c2b280;
      color: #000;
      box-shadow: 2px 2px #1f1f1f;
    }
    select option { background-color: #c2b280; color: #000; }
    button { cursor: pointer; transition: 0.2s; }
    .btn-add { background: #00aa00; color: white; }
    .btn-edit { background: #ffaa00; color: black; }
    .btn-save { background: #0099ff; color: white; }
    .btn-delete { background: #cc0000; color: white; }
    .btn-lucro {
      background: #6a5acd; color: white; margin-top: 10px; float: right; box-shadow: 0 0 10px #6a5acd;
    }
    .btn-add:hover,.btn-edit:hover,.btn-save:hover,.btn-delete:hover,.btn-lucro:hover {
      transform: scale(1.05); filter: brightness(1.1);
    }
    table {
      width: 100%; margin-top: 20px; border-collapse: collapse; background-color: #5c5c5c;
    }
    thead { background: #006400; color: #fff; }
    th, td { padding: 10px; border: 2px solid #000; text-align: center; }
    .lucro { margin-top: 15px; font-weight: bold; color: #8fff5f; text-align: right; text-shadow: 1px 1px #000; }
    input[type="radio"] { transform: scale(1.2); margin-right: 5px; }
    ::placeholder { color: #333; }
  </style>
</head>
<body>
  <div class="container">
    <h2>‚õè Controle de Compras e Vendas</h2>

    <div>
      <input id="nome" placeholder="Nome do item">
      <!-- campos de valor em TEXT p/ aceitar v√≠rgula/ponto -->
      <input id="compra" type="text" placeholder="Valor compra">
      <input id="venda" type="text" placeholder="Valor venda (opcional)">
      <input id="dataCompra" type="date">
      <input id="dataVenda" type="date">
      <select id="categoria">
        <option value="">Categoria</option>
        <option>Fonte</option><option>SSD</option><option>HD</option><option>Mem√≥ria RAM</option>
        <option>Placa-m√£e</option><option>Processador</option><option>Placa de V√≠deo</option>
        <option>Cooler</option><option>Gabinete</option><option>Teclado</option><option>Mouse</option>
        <option>Monitor</option><option>Cabo</option><option>Head-set</option><option>Outros</option>
      </select>
      <button class="btn-add" onclick="adicionar()">‚ûï Adicionar</button>
      <a href="lucro.html"><button class="btn-lucro">üìä Ver Lucro Mensal</button></a>
      <a href="comparativo.html">
        <button class="btn-lucro" style="background:#25e00c; box-shadow:0 0 10px #09e61c;">üìà Comparar KAYN x ANTONIO PEDRO</button>
      </a>
    </div>

    <div style="margin-top: 20px;">
      <label><input type="radio" name="filtro" value="todos" checked onchange="mostrar()"> Todos</label>
      <label><input type="radio" name="filtro" value="vendidos" onchange="mostrar()"> Vendidos</label>
      <label><input type="radio" name="filtro" value="naoVendidos" onchange="mostrar()"> N√£o Vendidos</label>
    </div>

    <div><input type="text" id="buscaCategoria" placeholder="üîç Buscar" oninput="mostrar()"></div>

    <div class="lucro" id="lucroTotal">üíé Lucro total: R$ 0,00</div>

    <table>
      <thead>
        <tr>
          <th>Nome</th><th>Compra</th><th>Venda</th><th>Lucro</th>
          <th>Data Compra</th><th>Data Venda</th><th>Categoria</th><th>A√ß√µes</th>
        </tr>
      </thead>
      <tbody id="tabela"></tbody>
    </table>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getFirestore, collection, addDoc, getDocs, deleteDoc, doc, updateDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
    import { getAnalytics } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-analytics.js";

    // Config Firebase (corrigido: storageBucket .appspot.com)
    const firebaseConfig = {
      apiKey: "AIzaSyAd4PhJku7IdcOkSlf_w7lMomfZdOlmxiQ",
      authDomain: "anotacoes-minhas.firebaseapp.com",
      projectId: "anotacoes-minhas",
      storageBucket: "anotacoes-minhas.appspot.com",
      messagingSenderId: "725833923909",
      appId: "1:725833923909:web:7fc54b2b340d962be1522c",
      measurementId: "G-2LQC2KWE4S"
    };

    const app = initializeApp(firebaseConfig);
    const analytics = getAnalytics(app);
    const db = getFirestore(app);
    const col = collection(db, "itens");

    // ===== Helpers =====
    function dateAtNoon(y, m, d) { return new Date(y, m - 1, d, 12, 0, 0, 0); } // evita shift de fuso
    function toDateFromInput(value) { // 'yyyy-mm-dd' -> Date 12:00
      if (!value) return null;
      const [y, m, d] = value.split('-').map(Number);
      return dateAtNoon(y, m, d);
    }
    function parseBRDate(str) { // 'dd/mm/aaaa' -> Date 12:00
      if (!str) return null;
      const m = str.match(/^(\d{1,2})\/(\d{1,2})\/(\d{4})$/);
      if (!m) return null;
      const d = +m[1], mo = +m[2], y = +m[3];
      return dateAtNoon(y, mo, d);
    }
    function asDate(stored) {
      if (!stored) return null;
      if (typeof stored?.toDate === 'function') return stored.toDate();
      if (typeof stored?.seconds === 'number') return new Date(stored.seconds * 1000);
      if (stored instanceof Date) return stored;
      if (typeof stored === 'number') return new Date(stored);
      if (typeof stored === 'string') return new Date(stored);
      return null;
    }
    function formatBRDate(stored) {
      const d = asDate(stored);
      return d && !isNaN(d.getTime()) ? d.toLocaleDateString('pt-BR') : '';
    }
    function parseMoney(str) {
      if (str == null) return NaN;
      let s = String(str).replace(/R\$\s?/i, '').trim(); // tira R$
      s = s.replace(/\./g, '').replace(',', '.');        // 1.234,56 -> 1234.56
      const n = parseFloat(s);
      return Number.isFinite(n) ? n : NaN;
    }
    const brl = (n) => Number.isFinite(n) ? n.toLocaleString('pt-BR', { style:'currency', currency:'BRL' }) : '';

    // ===== Prefill Data Compra = hoje (edit√°vel) =====
    function todayInputValue(){
      const t = new Date();
      const y = t.getFullYear(), m = String(t.getMonth()+1).padStart(2,'0'), d = String(t.getDate()).padStart(2,'0');
      return `${y}-${m}-${d}`;
    }
    const dcEl = document.getElementById('dataCompra');
    if (dcEl && !dcEl.value) dcEl.value = todayInputValue();

    // ===== CRUD =====
    async function adicionar() {
      const nome = document.getElementById('nome').value.trim();
      const compra = parseMoney(document.getElementById('compra').value);
      const vendaInput = document.getElementById('venda').value;
      const venda = vendaInput !== '' ? parseMoney(vendaInput) : null;

      const dataCompra = toDateFromInput(document.getElementById('dataCompra').value);
      const dataVenda  = toDateFromInput(document.getElementById('dataVenda').value);
      const categoria  = document.getElementById('categoria').value.trim();

      if (!nome || !categoria) { alert("Preencha os campos obrigat√≥rios (nome e categoria)."); return; }
      if (!Number.isFinite(compra) || compra < 0) { alert("Valor de compra inv√°lido (aceita 0 ou positivo)."); return; }
      if (venda !== null && (!Number.isFinite(venda) || venda < 0)) { alert("Valor de venda inv√°lido."); return; }

      await addDoc(col, { nome, compra, venda, dataCompra, dataVenda, categoria });
      limpar();
      mostrar();
    }

    async function mostrar() {
      const filtro = document.querySelector('input[name="filtro"]:checked').value;
      const termoBusca = document.getElementById('buscaCategoria')?.value.toLowerCase() || "";
      const tabela = document.getElementById('tabela');
      tabela.innerHTML = "";
      const docs = await getDocs(col);
      let lucroTotal = 0;

      docs.forEach(d => {
        const item = d.data();
        const id = d.id;
        const vendido = item.venda !== null && item.venda !== undefined;

        if ((filtro === 'vendidos' && !vendido) || (filtro === 'naoVendidos' && vendido)) return;
        if (termoBusca && !item.categoria?.toLowerCase().includes(termoBusca)) return;

        const lucro = vendido ? (item.venda - item.compra) : null;
        if (vendido) lucroTotal += (item.venda - item.compra);

        const dataCompraStr = formatBRDate(item.dataCompra);
        const dataVendaStr  = formatBRDate(item.dataVenda);

        tabela.innerHTML += `
          <tr id="linha-${id}">
            <td contenteditable="false">${item.nome ?? ""}</td>
            <td contenteditable="false">${brl(item.compra)}</td>
            <td contenteditable="false">${item.venda != null ? brl(item.venda) : ""}</td>
            <td>${vendido ? brl(lucro) : "-"}</td>
            <td contenteditable="false">${dataCompraStr}</td>
            <td contenteditable="false">${dataVendaStr}</td>
            <td contenteditable="false">${item.categoria ?? ""}</td>
            <td>
              <button class="btn-edit" onclick="editar('${id}')">‚úèÔ∏è</button>
              <button class="btn-save" onclick="salvar('${id}')" style="display:none;">üìÇ</button>
              <button class="btn-delete" onclick="excluir('${id}')">üóëÔ∏è</button>
              <button onclick="detalhes('${id}')">üîç</button>
            </td>
          </tr>
        `;
      });

      document.getElementById("lucroTotal").innerText = `üíé Lucro total: ${brl(lucroTotal)}`;
    }

    async function excluir(id) {
      await deleteDoc(doc(db, "itens", id));
      mostrar();
    }

    function editar(id) {
      const linha = document.getElementById(`linha-${id}`);
      const cels = linha.querySelectorAll("td");
      for (let i = 0; i < 7; i++) cels[i].setAttribute("contenteditable", "true");
      linha.querySelector(".btn-edit").style.display = "none";
      linha.querySelector(".btn-save").style.display = "inline-block";
    }

    async function salvar(id) {
      const linha = document.getElementById(`linha-${id}`);
      const cels = linha.querySelectorAll("td");

      const nome = cels[0].innerText.trim();
      const compra = parseMoney(cels[1].innerText);
      const venda  = cels[2].innerText.trim() !== '' ? parseMoney(cels[2].innerText) : null;

      const dataCompraStr = cels[4].innerText.trim();
      const dataVendaStr  = cels[5].innerText.trim();
      const dataCompra = parseBRDate(dataCompraStr) ?? toDateFromInput(dataCompraStr) ?? null;
      const dataVenda  = parseBRDate(dataVendaStr)  ?? toDateFromInput(dataVendaStr)  ?? null;

      const categoria = cels[6].innerText.trim();

      if (!nome || !categoria) { alert("Preencha os campos obrigat√≥rios (nome e categoria)."); return; }
      if (!Number.isFinite(compra) || compra < 0) { alert("Valor de compra inv√°lido (aceita 0 ou positivo)."); return; }
      if (venda !== null && (!Number.isFinite(venda) || venda < 0)) { alert("Valor de venda inv√°lido."); return; }

      await updateDoc(doc(db, "itens", id), { nome, compra, venda, dataCompra, dataVenda, categoria });

      for (let i = 0; i < 7; i++) cels[i].setAttribute("contenteditable", "false");
      linha.querySelector(".btn-edit").style.display = "inline-block";
      linha.querySelector(".btn-save").style.display = "none";

      mostrar();
    }

    function limpar() {
      document.getElementById('nome').value = "";
      document.getElementById('compra').value = "";
      document.getElementById('venda').value = "";
      document.getElementById('dataCompra').value = todayInputValue(); // mant√©m hoje
      document.getElementById('dataVenda').value = "";
      document.getElementById('categoria').value = "";
    }

    function detalhes(id) {
      window.location.href = `detalhes.html?id=${id}`;
    }

    window.adicionar = adicionar;
    window.mostrar = mostrar;
    window.excluir = excluir;
    window.editar = editar;
    window.salvar = salvar;
    window.detalhes = detalhes;

    mostrar();
  </script>
</body>
</html>
